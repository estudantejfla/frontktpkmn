<script>
const API = "https://backpkmn.onrender.com";
const token = localStorage.getItem("token");
const username = localStorage.getItem("username");

if (!token) {
  alert("Você precisa estar logado");
  window.location.href = "index.html";
}

document.getElementById("usuario").textContent = username;

let pokemonList = [];

async function loadPokemonList() {
  for (let i = 1; i <= 151; i++) {
    const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${i}`);
    pokemonList.push(await res.json());
  }
  loadTeams();
}

function getSprite(name) {
  let p = pokemonList.find(p => p.name === name.toLowerCase());
  return p ? p.sprites.front_default : "";
}

async function loadTeams() {
  const res = await fetch(`${API}/api/teams`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  const teams = await res.json();
  const div = document.getElementById("meusTimes");

  if (teams.length === 0) {
    div.innerHTML = "<p>Você ainda não criou nenhum time.</p>";
    return;
  }

  div.innerHTML = "";

  teams.forEach(t => {
    const pokemons = JSON.parse(t.pokemons);

    const card = document.createElement("div");
    card.className = "card";

    let pokeHTML = pokemons.map(p => `
      <div class="pokemon-item">
        <img src="${getSprite(p)}" width="40">
        <span>${p}</span>
      </div>
    `).join("");

    card.innerHTML = `
      <h3>${t.name}</h3>
      <p>Status: ${t.isPublic ? "Público" : "Privado"}</p>
      <div class="pokemon-container">${pokeHTML}</div>
      <button onclick="editar(${t.id})">Editar</button>
      <button onclick="excluir(${t.id})">Excluir</button>
      ${t.isPublic 
        ? `<button onclick="privar(${t.id})">Tornar Privado</button>`
        : `<button onclick="publicar(${t.id})">Tornar Público</button>`
      }
    `;

    div.appendChild(card);
  });
}

function editar(id) {
  window.location.href = `criar_time.html?edit=${id}`;
}

async function excluir(id) {
  if (!confirm("Deseja excluir este time?")) return;

  await fetch(`${API}/api/teams/${id}`, {
    method: "DELETE",
    headers: { Authorization: `Bearer ${token}` }
  });

  loadTeams();
}

async function publicar(id) {
  await fetch(`${API}/api/teams/${id}/public`, {
    method: "PATCH",
    headers: { Authorization: `Bearer ${token}` }
  });

  loadTeams();
}

async function privar(id) {
  await fetch(`${API}/api/teams/${id}/private`, {
    method: "PATCH",
    headers: { Authorization: `Bearer ${token}` }
  });

  loadTeams();
}

function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("username");
  window.location.href = "index.html";
}

loadPokemonList();
</script>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Criar Time</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <video autoplay muted loop id="bg-video" class="background-video">
    <source src="imagens/background.mp4" type="video/mp4">
  </video>

  <div class="container">
    <div class="navbar">
      <a href="index.html">Login</a>
      <a href="times.html">Meus Times</a>
      <a href="criar_time.html">Criar Time</a>
      <a href="publicos.html">Times Públicos</a>
    </div>

    <h1>Criar Time</h1>
    <p>Usuário: <span id="usuario"></span></p>

    <input id="nomeTime" placeholder="Nome do Time"><br>

    <h3>Seu Time (6 Pokémon máximo)</h3>
    <div id="slots" class="grid"></div>

    <div id="pokemonModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>

        <input type="text" id="pokemonSearch" placeholder="Buscar Pokémon..." oninput="buscarPokemon()">
        <div id="pokemonList" class="grid"></div>
      </div>
    </div>

    <button onclick="salvarTime()">Salvar Time</button><br><br>
    <button onclick="limparTime()" style="background-color:#f44336;">Limpar Time</button><br><br>

    <a href="times.html">Voltar</a>
  </div>

<script>
const API = "https://backpkmn.onrender.com";
const token = localStorage.getItem("token");
const username = localStorage.getItem("username");

if (!token) {
  alert("Você precisa estar logado");
  window.location.href = "index.html";
}

document.getElementById("usuario").textContent = username;

let slots = []; 
let pokemonList = [];

async function loadPokemonList() {
  for (let i = 1; i <= 151; i++) {
    let res = await fetch(`https://pokeapi.co/api/v2/pokemon/${i}`);
    let data = await res.json();
    pokemonList.push(data);
  }
  carregarPokemons();
  mostrarSlots();
}

function getSprite(name) {
  let p = pokemonList.find(p => p.name === name.toLowerCase());
  return p ? p.sprites.front_default : "";
}

function mostrarSlots() {
  let container = document.getElementById("slots");
  container.innerHTML = "";

  for (let i = 0; i < 6; i++) {
    let div = document.createElement("div");
    div.className = "card";

    if (slots[i]) {
      div.innerHTML = `
        <img src="${getSprite(slots[i])}" width="60">
        <p>${slots[i]}</p>
        <button onclick="removerPokemon(${i})">Remover</button>
      `;
    } else {
      div.innerHTML = `<button onclick="abrirModal(${i})">Adicionar Pokémon</button>`;
    }

    container.appendChild(div);
  }
}

let modal = null;
let currentSlot = 0;

window.onload = () => {
  modal = document.getElementById("pokemonModal");
};

function abrirModal(i) {
  currentSlot = i;
  modal.style.display = "block";
}

function fecharModal() {
  modal.style.display = "none";
}

document.querySelector(".close").onclick = fecharModal;

window.onclick = (e) => {
  if (e.target == modal) fecharModal();
};

function carregarPokemons() {
  let container = document.getElementById("pokemonList");
  container.innerHTML = "";

  pokemonList.forEach(poke => {
    let div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <img src="${poke.sprites.front_default}" width="60">
      <p>${poke.name}</p>
      <button onclick="selecionarPokemon('${poke.name}')">Adicionar</button>
    `;
    container.appendChild(div);
  });
}

function buscarPokemon() {
  let termo = document.getElementById("pokemonSearch").value.toLowerCase();
  document.querySelectorAll("#pokemonList .card").forEach(card => {
    let nome = card.querySelector("p").textContent.toLowerCase();
    card.style.display = nome.includes(termo) ? "block" : "none";
  });
}

function selecionarPokemon(name) {
  slots[currentSlot] = name;
  mostrarSlots();
  fecharModal();
}

function removerPokemon(i) {
  slots[i] = null;
  mostrarSlots();
}

async function salvarTime() {
  const name = document.getElementById("nomeTime").value;
  const pokemons = slots.filter(p => p);

  if (!name || pokemons.length === 0) {
    alert("O time precisa ter nome e pelo menos 1 Pokémon!");
    return;
  }

  const body = {
    name,
    pokemons,
    isPublic: false
  };

  const res = await fetch(`${API}/api/teams`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    alert("Erro ao salvar time!");
    return;
  }

  alert("Time salvo com sucesso!");
  window.location.href = "times.html";
}

function limparTime() {
  slots = [];
  document.getElementById("nomeTime").value = "";
  mostrarSlots();
}

loadPokemonList();
</script>

</body>
</html>
